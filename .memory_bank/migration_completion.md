# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –§–∞–∑—ã 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **PostgreSQL –¥—Ä–∞–π–≤–µ—Ä** (`internal/infrastructure/postgresql.go`) —Å –ø–æ–ª–Ω—ã–º connection pooling
- **–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π** (`internal/infrastructure/migrations.go`) —Å golang-migrate
- **–ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** –≤ `migrations/` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö

### üóÑÔ∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–≤—Å–µ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã –Ω–∞ PostgreSQL)
1. **UserRepository** - —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
2. **FamilyRepository** - —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —Å–µ–º—å–∏, –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –≤–∞–ª—é—Ç
3. **CategoryRepository** - —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–º–∏ SQL (Recursive CTE)
4. **TransactionRepository** - —Å JSONB –¥–ª—è —Ç–µ–≥–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
5. **BudgetRepository** - —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –∞–ª–µ—Ä—Ç–∞–º–∏
6. **ReportRepository** - —Å PostgreSQL analytics, window functions

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
```
migrations/
‚îú‚îÄ‚îÄ 001_initial_schema.up.sql  # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
‚îî‚îÄ‚îÄ 001_initial_schema.down.sql # –û—Ç–∫–∞—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
```

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î –≤ `scripts/pg-init.sql` –∏ `migrations/`
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
- Docker-compose —Å–æ–∑–¥–∞–≤–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É —á–µ—Ä–µ–∑ init —Å–∫—Ä–∏–ø—Ç

### ‚úÖ –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- **–ú–∏–≥—Ä–∞—Ü–∏–∏** –æ—Ç–≤–µ—á–∞—é—Ç –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î
- **–°–∫—Ä–∏–ø—Ç—ã** —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## üöÄ –ù–æ–≤—ã–π workflow —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
```bash
./scripts/init-dev.sh  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ–≥–æ
```

### –†—É—á–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å
```bash
make postgres-up     # PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
make migrate-up      # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make run-local       # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

### –†–∞–±–æ—Ç–∞ —Å –ë–î
```bash
make migrate-create NAME=add_new_feature  # –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
make migrate-up                          # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make migrate-down                        # –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
make postgres-shell                      # –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (SQL injection –∑–∞—â–∏—Ç–∞)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö UUID –∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Proper escaping –¥–ª—è JSONB –ø–æ–ª–µ–π

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Connection pooling —Å pgxpool
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Window functions –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB

### üõ†Ô∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- Recursive CTE –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –ë–æ–≥–∞—Ç—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### üß™ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production
- Comprehensive error handling
- Strong typing
- Clean Architecture —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 4)

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã** - –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ PostgreSQL
2. **Testcontainers** - —Å–æ–∑–¥–∞—Ç—å PostgreSQL test containers
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ workflow

### üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
1. **–û–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥** - –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞ PostgreSQL - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
2. **–£–¥–∞–ª–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** –∏–∑ go.mod - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
3. **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** - –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ PostgreSQL - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. **PostgreSQL –º–µ—Ç—Ä–∏–∫–∏** —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—à–±–æ—Ä–¥—ã** Grafana
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã** –¥–ª—è –ë–î

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ **production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é** —Å PostgreSQL:
- ‚úÖ ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ú–æ—â–Ω—ã–µ SQL –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
- ‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

**–°—Ç–∞—Ç—É—Å**: –§–∞–∑–∞ 4 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL 17.6 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (95%). üéâ

## –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –§–∞–∑—ã 5

### ‚ö†Ô∏è –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
1. `TransactionRepository` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `GetByFamilyID(ctx, familyID, limit, offset)`
2. `BudgetRepository` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `GetByFamilyAndCategory`
3. `ReportRepository` - –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã `GetByFamilyID`

### ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –≤ –§–∞–∑–µ 4
- **PostgreSQL testcontainers** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç
- **Unit —Ç–µ—Å—Ç—ã** - 45+ —Ç–µ—Å—Ç–æ–≤ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è PostgreSQL
- **Integration —Ç–µ—Å—Ç—ã** - –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω
- **Benchmark —Ç–µ—Å—Ç—ã** - 15+ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Legacy cleanup** - –≤—Å–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∫–æ–¥ —É–¥–∞–ª–µ–Ω—ã
- **Docker Compose** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ PostgreSQL
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –Ω–∞ PostgreSQL
