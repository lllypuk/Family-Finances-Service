# Feature Specification - Web Interface для всех сущностей

> **Статус**: 🔄 В разработке  
> **Приоритет**: 🔴 Высокий  
> **Версия**: v1.0  
> **Автор**: Claude  
> **Дата создания**: 2025-08-15  
> **Последнее обновление**: 2025-08-15

## 📋 Краткое описание

Реализация веб-интерфейса для управления всеми сущностями системы семейного бюджета с использованием HTMX для динамических взаимодействий и PicoCSS для стилизации. Интерфейс предоставит полный CRUD-функционал для пользователей, категорий, транзакций, бюджетов и отчетов.

## 🎯 Бизнес-контекст

### Проблема
- Отсутствует веб-интерфейс для взаимодействия с API
- Пользователи не могут управлять семейным бюджетом через удобный интерфейс
- Необходим простой, быстрый и отзывчивый интерфейс без сложных фреймворков

### Цели и метрики успеха
- **Основная цель**: Создать полнофункциональный веб-интерфейс для всех операций системы
- **Метрики**: 
  - [ ] Время загрузки страниц < 200ms
  - [ ] Поддержка всех CRUD операций для каждой сущности
  - [ ] Responsive дизайн для мобильных устройств

### Целевая аудитория
- **Основные пользователи**: Семьи, управляющие домашним бюджетом
- **Роли**: Администраторы семьи, члены семьи, дети с ограниченными правами

## 📊 Требования

### Функциональные требования

#### Must Have (Обязательно)

##### Пользователи и семьи
- [ ] **FR-001**: Регистрация новой семьи
  - **Критерий приемки**: Форма создания семьи с валидацией полей
  - **Приоритет**: Высокий

- [ ] **FR-002**: Управление пользователями семьи
  - **Критерий приемки**: CRUD операции для пользователей с ролевой моделью
  - **Приоритет**: Высокий

- [ ] **FR-003**: Аутентификация и авторизация
  - **Критерий приемки**: Вход/выход, проверка прав доступа по ролям
  - **Приоритет**: Высокий

##### Категории
- [ ] **FR-004**: Управление категориями доходов и расходов
  - **Критерий приемки**: CRUD для категорий с поддержкой подкатегорий
  - **Приоритет**: Высокий

- [ ] **FR-005**: Цветовая индикация и иконки категорий
  - **Критерий приемки**: Выбор цвета и иконки при создании/редактировании
  - **Приоритет**: Средний

##### Транзакции
- [ ] **FR-006**: Добавление и редактирование транзакций
  - **Критерий приемки**: Форма с валидацией для создания/редактирования транзакций
  - **Приоритет**: Высокий

- [ ] **FR-007**: Фильтрация и поиск транзакций
  - **Критерий приемки**: Фильтры по дате, категории, типу, сумме, тегам
  - **Приоритет**: Высокий

- [ ] **FR-008**: Массовые операции с транзакциями
  - **Критерий приемки**: Выбор нескольких транзакций для удаления/редактирования
  - **Приоритет**: Средний

##### Бюджеты
- [ ] **FR-009**: Создание и управление бюджетами
  - **Критерий приемки**: CRUD для бюджетов с различными периодами
  - **Приоритет**: Высокий

- [ ] **FR-010**: Визуализация использования бюджета
  - **Критерий приемки**: Прогресс-бары и индикаторы превышения бюджета
  - **Приоритет**: Высокий

- [ ] **FR-011**: Настройка уведомлений бюджета
  - **Критерий приемки**: Настройка порогов для уведомлений (50%, 80%, 100%)
  - **Приоритет**: Средний

##### Отчеты
- [ ] **FR-012**: Генерация различных типов отчетов
  - **Критерий приемки**: Отчеты по расходам, доходам, бюджету, cash flow
  - **Приоритет**: Высокий

- [ ] **FR-013**: Визуализация данных отчетов
  - **Критерий приемки**: Графики и диаграммы с использованием Chart.js
  - **Приоритет**: Средний

#### Should Have (Желательно)
- [ ] **FR-014**: Экспорт данных
  - **Критерий приемки**: Экспорт отчетов в CSV/PDF
  - **Приоритет**: Средний

- [ ] **FR-015**: Темная тема
  - **Критерий приемки**: Переключатель темной/светлой темы
  - **Приоритет**: Низкий

#### Could Have (Можно добавить)
- [ ] **FR-016**: Мобильное приложение PWA
  - **Критерий приемки**: Возможность установки как PWA
  - **Приоритет**: Низкий

### Нефункциональные требования

#### Производительность
- **Время отклика**: < 200ms для всех HTMX запросов
- **Размер страницы**: < 500KB включая CSS и JS
- **Время первой загрузки**: < 1s

#### Безопасность
- **Аутентификация**: Session-based с защитой CSRF
- **Авторизация**: Проверка прав доступа на каждый запрос
- **Валидация данных**: Client-side и server-side валидация
- **XSS защита**: Экранирование всех пользовательских данных

#### Совместимость
- **Браузеры**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **Мобильные устройства**: iOS Safari, Chrome Mobile
- **Доступность**: WCAG 2.1 AA уровень

## 🎨 Пользовательские сценарии

### Основной сценарий - Добавление транзакции
```
Как член семьи
Я хочу добавить новую транзакцию расхода
Чтобы отслеживать трата семейного бюджета

Шаги:
1. Пользователь переходит на страницу "Транзакции"
2. Нажимает кнопку "Добавить транзакцию"
3. Заполняет форму: сумма, категория, описание, дата
4. Нажимает "Сохранить"
5. HTMX отправляет POST запрос
6. Сервер валидирует данные и сохраняет
7. Страница обновляется с новой транзакцией в списке

Ожидаемый результат:
- Транзакция создана и отображается в списке
- Бюджет автоматически пересчитан
- Пользователь видит уведомление об успехе
```

### Альтернативный сценарий - Ошибка валидации
```
Сценарий: Некорректные данные в форме транзакции
1. Пользователь вводит отрицательную сумму
2. HTMX отправляет запрос с client-side валидацией
3. Сервер возвращает ошибки валидации
4. HTMX обновляет форму с сообщениями об ошибках
5. Пользователь исправляет данные и повторяет попытку
```

### Граничные случаи
- **Сетевые ошибки**: Отображение сообщения о потере соединения
- **Сессия истекла**: Автоматическое перенаправление на страницу входа
- **Большие списки**: Пагинация для списков > 50 элементов
- **Конкурентное редактирование**: Предупреждение о изменениях другими пользователями

## 🏗️ Техническое решение

### Архитектурное решение
```
Frontend Architecture:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   HTML Templates│    │   HTMX Actions  │    │   Go Handlers   │
│   (PicoCSS)     │◄──►│   (Dynamic UI)  │◄──►│   (API Logic)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Static Assets │    │   Client State  │    │   Session Store │
│   (CSS/JS/IMG)  │    │   (Forms/UI)    │    │   (Auth/Data)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘

Компоненты:
- HTML Templates: Server-side рендеринг с Go templates
- HTMX: Обработка Ajax запросов и обновление DOM
- PicoCSS: Минималистичная CSS библиотека
- Go Handlers: Обработка HTTP запросов и бизнес-логика
```

### Структура веб-интерфейса

#### Страницы и маршруты
```
GET  /                      - Главная страница (дашборд)
GET  /login                 - Страница входа
POST /login                 - Обработка входа
GET  /register              - Регистрация семьи
POST /register              - Обработка регистрации
GET  /logout                - Выход

GET  /users                 - Список пользователей семьи
GET  /users/new             - Форма добавления пользователя
POST /users                 - Создание пользователя
GET  /users/{id}/edit       - Форма редактирования
PUT  /users/{id}            - Обновление пользователя
DELETE /users/{id}          - Удаление пользователя

GET  /categories            - Список категорий
GET  /categories/new        - Форма создания категории
POST /categories            - Создание категории
GET  /categories/{id}/edit  - Форма редактирования
PUT  /categories/{id}       - Обновление категории
DELETE /categories/{id}     - Удаление категории

GET  /transactions          - Список транзакций с фильтрами
GET  /transactions/new      - Форма добавления транзакции
POST /transactions          - Создание транзакции
GET  /transactions/{id}/edit - Форма редактирования
PUT  /transactions/{id}     - Обновление транзакции
DELETE /transactions/{id}   - Удаление транзакции

GET  /budgets               - Список бюджетов
GET  /budgets/new           - Форма создания бюджета
POST /budgets               - Создание бюджета
GET  /budgets/{id}/edit     - Форма редактирования
PUT  /budgets/{id}          - Обновление бюджета
DELETE /budgets/{id}        - Удаление бюджета

GET  /reports               - Страница отчетов
POST /reports/generate      - Генерация отчета
GET  /reports/{id}          - Просмотр отчета
```

#### HTMX Endpoints для динамических обновлений
```
GET  /htmx/dashboard/stats     - Обновление статистики дашборда
GET  /htmx/transactions/list   - Обновление списка транзакций
POST /htmx/transactions/filter - Фильтрация транзакций
GET  /htmx/budgets/progress    - Обновление прогресса бюджетов
GET  /htmx/categories/select   - Выпадающий список категорий
POST /htmx/forms/validate      - Валидация форм в реальном времени
```

### Структура директорий
```
internal/
├── web/
│   ├── handlers/
│   │   ├── auth.go          - Аутентификация
│   │   ├── dashboard.go     - Главная страница
│   │   ├── users.go         - Управление пользователями
│   │   ├── categories.go    - Управление категориями
│   │   ├── transactions.go  - Управление транзакциями
│   │   ├── budgets.go       - Управление бюджетами
│   │   ├── reports.go       - Отчеты
│   │   └── htmx.go          - HTMX endpoints
│   ├── middleware/
│   │   ├── auth.go          - Middleware аутентификации
│   │   ├── csrf.go          - CSRF защита
│   │   └── session.go       - Управление сессиями
│   ├── templates/
│   │   ├── layouts/
│   │   │   ├── base.html    - Базовый layout
│   │   │   └── auth.html    - Layout для страниц авторизации
│   │   ├── pages/
│   │   │   ├── dashboard.html
│   │   │   ├── users/
│   │   │   ├── categories/
│   │   │   ├── transactions/
│   │   │   ├── budgets/
│   │   │   └── reports/
│   │   └── components/
│   │       ├── forms/       - Переиспользуемые формы
│   │       ├── tables/      - Компоненты таблиц
│   │       └── cards/       - Карточки и виджеты
│   └── static/
│       ├── css/
│       │   ├── pico.min.css - PicoCSS
│       │   └── custom.css   - Кастомные стили
│       ├── js/
│       │   ├── htmx.min.js  - HTMX библиотека
│       │   ├── chart.min.js - Chart.js для графиков
│       │   └── app.js       - Дополнительная JS логика
│       └── img/
│           └── icons/       - Иконки категорий
```

### Модель данных для веб-интерфейса

#### Session Store
```go
type Session struct {
    ID       string
    UserID   uuid.UUID
    FamilyID uuid.UUID
    Role     user.Role
    ExpiresAt time.Time
}
```

#### View Models
```go
type DashboardViewModel struct {
    User              *user.User
    Family            *user.Family
    RecentTransactions []transaction.Transaction
    BudgetProgress    []BudgetProgressItem
    MonthlyStats      MonthlyStatsItem
}

type BudgetProgressItem struct {
    Budget     budget.Budget
    Percentage float64
    IsOverBudget bool
    RemainingDays int
}

type MonthlyStatsItem struct {
    TotalIncome   float64
    TotalExpenses float64
    NetIncome     float64
    TopCategories []category.Category
}
```

### Интеграции
- **HTMX**: Для Ajax запросов без JavaScript
- **PicoCSS**: Минималистичная CSS библиотека
- **Chart.js**: Графики и диаграммы для отчетов
- **Go Templates**: Server-side рендеринг HTML

## 🧪 Тестирование

### Стратегия тестирования
- **Unit Tests**: Тестирование handlers и middleware (80% покрытие)
- **Integration Tests**: Тестирование full-stack сценариев
- **E2E Tests**: Playwright тесты для критических пользовательских сценариев

### Тест-кейсы

#### Аутентификация и авторизация
```
TC-001: Успешный вход в систему
- Preconditions: Пользователь зарегистрирован
- Steps: Ввести email/пароль, нажать "Войти"
- Expected: Перенаправление на дашборд, сессия создана

TC-002: Доступ к защищенным страницам
- Preconditions: Пользователь не авторизован
- Steps: Попытаться зайти на /transactions
- Expected: Перенаправление на /login

TC-003: Ролевая авторизация
- Preconditions: Пользователь с ролью "child" авторизован
- Steps: Попытаться удалить транзакцию
- Expected: 403 Forbidden, сообщение об ошибке
```

#### CRUD операции
```
TC-004: Создание транзакции через HTMX
- Preconditions: Пользователь авторизован
- Steps: Заполнить форму, отправить через HTMX
- Expected: Новая транзакция в списке без перезагрузки страницы

TC-005: Валидация данных формы
- Preconditions: Пользователь на странице создания бюджета
- Steps: Ввести некорректные данные, отправить форму
- Expected: Ошибки валидации отображаются inline
```

#### Responsive дизайн
```
TC-006: Мобильная версия
- Preconditions: Открыть сайт на мобильном устройстве
- Steps: Навигация по основным страницам
- Expected: Удобный интерфейс, все функции доступны

TC-007: Работа с формами на тач-устройствах
- Preconditions: Мобильное устройство
- Steps: Заполнить форму добавления транзакции
- Expected: Удобный ввод, правильная клавиатура для числовых полей
```

### Performance Tests
- **Lighthouse Score**: > 90 для всех метрик
- **Page Load**: < 1s первая загрузка
- **HTMX Requests**: < 200ms ответ сервера

## 📈 Мониторинг и метрики

### Технические метрики
- **Response Time**: P50, P95 для всех endpoints
- **Error Rate**: % HTTP 4xx/5xx ошибок
- **Session Duration**: Средняя длительность сессии
- **Page Views**: Популярность страниц

### Пользовательские метрики
- **User Adoption**: % семей, использующих веб-интерфейс
- **Feature Usage**: Статистика использования функций
- **Conversion Rate**: Регистрация → активное использование
- **User Satisfaction**: Время выполнения задач

### Алерты
- **Critical**: Response time > 1s
- **Warning**: Error rate > 2%
- **Info**: Высокая нагрузка на сессии

## 🚀 План развертывания

### Этапы разработки

#### Phase 1: Базовая инфраструктура (1-2 недели)
- [ ] Настройка web router и middleware
- [ ] Базовые templates и layouts
- [ ] Аутентификация и сессии
- [ ] Интеграция PicoCSS и HTMX

#### Phase 2: Core функционал (2-3 недели)
- [ ] CRUD для всех сущностей
- [ ] Дашборд с основной статистикой
- [ ] Базовые формы с валидацией
- [ ] Responsive дизайн

#### Phase 3: Расширенные функции (1-2 недели)
- [ ] Фильтрация и поиск
- [ ] Отчеты с визуализацией
- [ ] Массовые операции
- [ ] Экспорт данных

#### Phase 4: Оптимизация (1 неделя)
- [ ] Performance оптимизация
- [ ] Accessibility улучшения
- [ ] Security audit
- [ ] Testing и bug fixes

### Feature Flags
```go
type WebFeatures struct {
    ReportsEnabled    bool `json:"reports_enabled"`
    ExportEnabled     bool `json:"export_enabled"`
    DarkThemeEnabled  bool `json:"dark_theme_enabled"`
    PWAEnabled        bool `json:"pwa_enabled"`
}
```

### Rollback Plan
- **Trigger**: Error rate > 5% или критические bugs
- **Action**: Откат к предыдущей версии через feature flag
- **Recovery**: < 5 минут через CI/CD pipeline

## 🔒 Безопасность

### Угрозы и митигации
- **XSS**: HTML escaping в templates, Content Security Policy
- **CSRF**: CSRF tokens для всех форм
- **Session Hijacking**: Secure cookies, HTTPS only
- **SQL Injection**: Параметризованные запросы в repository слое
- **Clickjacking**: X-Frame-Options заголовки

### Аудит безопасности
- **Authentication Events**: Логирование входов/выходов
- **Data Access**: Аудит всех CRUD операций
- **Admin Actions**: Полный лог административных действий
- **Failed Attempts**: Мониторинг неудачных попыток входа

## 📚 Документация

### Обновления документации
- [ ] User Guide для веб-интерфейса
- [ ] Admin Guide по управлению пользователями
- [ ] Developer Guide по добавлению новых страниц
- [ ] API документация для HTMX endpoints

### Обучение команды
- [ ] Workshop по HTMX и PicoCSS
- [ ] Code review guidelines для web handlers
- [ ] Security checklist для веб-разработки

## ⚠️ Риски и митигации

### Технические риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| HTMX complexity | Средняя | Среднее | Постепенное внедрение, fallback на обычные формы |
| Browser compatibility | Низкая | Среднее | Тестирование на основных браузерах |
| Performance issues | Средняя | Высокое | Профилирование, lazy loading |

### Пользовательские риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Low adoption | Средняя | Высокое | UX тестирование, пользовательская обратная связь |
| Learning curve | Высокая | Среднее | Интуитивный интерфейс, help tooltips |

## 📅 Временные рамки

### Milestone 1: MVP (3 недели)
- [ ] Базовая аутентификация
- [ ] CRUD для транзакций и категорий
- [ ] Простой дашборд

### Milestone 2: Feature Complete (5 недель)
- [ ] Все CRUD операции
- [ ] Фильтрация и поиск
- [ ] Базовые отчеты

### Milestone 3: Production Ready (6 недель)
- [ ] Performance optimization
- [ ] Security audit
- [ ] Comprehensive testing

## ✅ Definition of Done

### Разработка
- [ ] Код написан и отревьюен
- [ ] Unit тесты покрывают > 80%
- [ ] Integration тесты для критических сценариев
- [ ] Security review пройден
- [ ] Accessibility проверена

### Тестирование
- [ ] E2E тесты проходят
- [ ] Performance требования выполнены
- [ ] Cross-browser testing
- [ ] Mobile testing

### Развертывание
- [ ] Production deployment готов
- [ ] Мониторинг настроен
- [ ] Документация обновлена
- [ ] Feature flags настроены

## 📝 Заметки и вопросы

### Открытые вопросы
- [ ] Нужна ли поддержка offline режима?
- [ ] Какой уровень кастомизации интерфейса требуется?
- [ ] Требуется ли интеграция с внешними банковскими API?

### Предположения
- Пользователи предпочитают простой и быстрый интерфейс
- HTMX обеспечит достаточную интерактивность без сложности SPA
- PicoCSS будет достаточен для всех дизайнерских потребностей

### Зависимости
- **Внешние**: Стабильная версия HTMX и PicoCSS
- **Внутренние**: Готовые API endpoints и middleware
- **Команды**: UX/UI консультации для улучшения пользовательского опыта

---

**Утверждение спецификации:**
- [ ] Product Owner: [Имя] - [Дата]
- [ ] Tech Lead: [Имя] - [Дата]
- [ ] Security Engineer: [Имя] - [Дата]

*Документ создан: 2025-08-15*  
*Владелец: Backend Team*  
*Следующий ревью: 2025-08-22*