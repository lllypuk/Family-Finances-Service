# –ó–∞–¥–∞—á–∞: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤ Service Layer Architecture

> **–°—Ç–∞—Ç—É—Å**: ‚úÖ –≠—Ç–∞–ø 2 –ó–ê–í–ï–†–®–ï–ù
> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
> **–¶–µ–ª—å**: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É API –∏ Web handlers
> **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-08-28
> **–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∞–ø–∞ 2**: 2025-08-29

## üéâ –ü–†–û–ì–†–ï–°–° –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û (29.08.2025)
- **‚úÖ –≠—Ç–∞–ø 1**: Service Layer –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∞
- **‚úÖ –≠—Ç–∞–ø 2**: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è UserService —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- **‚úÖ –≠—Ç–∞–ø 3**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API UserHandler –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
- **‚úÖ –≠—Ç–∞–ø 5**: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è (916/916 —Ç–µ—Å—Ç–æ–≤, 0 linter –æ—à–∏–±–æ–∫)

### üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢–´
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** –º–µ–∂–¥—É handlers –∏ –ø—Ä—è–º—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º repositories
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** –≤ UserService (–≤–∞–ª–∏–¥–∞—Ü–∏—è, bcrypt hashing, –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞)
- **–£–ª—É—á—à–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - Clean Architecture —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ–µ–≤
- **100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏** Service Layer —Å –ø–æ–ª–Ω—ã–º–∏ mocks –∏ edge cases
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã** - –Ω–∏–∫–∞–∫–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints –Ω–µ —Å–ª–æ–º–∞–Ω—ã

### üìã –û–°–¢–ê–õ–û–°–¨ –°–î–ï–õ–ê–¢–¨
- [ ] **–≠—Ç–∞–ø 4**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Web Handler –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è UserService
- [ ] **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤ (Family, Category, Transaction, Budget, Report)

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Ü–µ–ª–∏

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** –º–µ–∂–¥—É `internal/application/handlers/users.go` –∏ `internal/web/handlers/users.go`
- **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞** –ø–æ transport layer handlers
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—â–µ–π –ª–æ–≥–∏–∫–∏
- **–ù–∞—Ä—É—à–µ–Ω–∏–µ DRY –ø—Ä–∏–Ω—Ü–∏–ø–∞** –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, —Å–æ–∑–¥–∞–Ω–∏–∏ entities

### –¶–µ–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –í—ã–Ω–µ—Å—Ç–∏ –æ–±—â—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ Service Layer
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É handlers
- ‚úÖ –£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –¥—Ä—É–≥–∏—Ö transport layers (gRPC, GraphQL)
- ‚úÖ –°–æ–±–ª—é—Å—Ç–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã Clean Architecture

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   API Handler   ‚îÇ    ‚îÇ   Web Handler   ‚îÇ
‚îÇ   (JSON/REST)   ‚îÇ    ‚îÇ  (HTML/HTMX)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ
          ‚îÇ –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï         ‚îÇ
          ‚îÇ –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ò        ‚îÇ
          ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Repositories  ‚îÇ
        ‚îÇ   (Data Layer)  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   API Handler   ‚îÇ    ‚îÇ   Web Handler   ‚îÇ
‚îÇ   (JSON/REST)   ‚îÇ    ‚îÇ  (HTML/HTMX)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Service Layer  ‚îÇ
        ‚îÇ (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Repositories  ‚îÇ
        ‚îÇ   (Data Layer)  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ Service Layer –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–ó–ê–í–ï–†–®–ï–ù)

#### ‚úÖ 1.1 –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤
- [x] **–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é** `internal/services/`
- [x] **–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** `internal/services/interfaces.go` —Å UserService
- [x] **–°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é** `internal/services/user_service.go`
- [x] **–î–æ–±–∞–≤–∏—Ç—å DI setup** –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ `internal/services/container.go`

#### ‚úÖ 1.2 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DTO –º–æ–¥–µ–ª–µ–π
- [x] **–°–æ–∑–¥–∞—Ç—å** `internal/services/dto/user_dto.go` —Å –æ–±—â–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏:
  - `CreateUserDTO`
  - `UpdateUserDTO`
  - `UserFilterDTO` (–Ω–µ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è)
  - `UserResponseDTO` (–Ω–µ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è)
- [x] **–°–æ–∑–¥–∞—Ç—å** `internal/services/dto/api_mappers.go` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

#### 1.3 –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ UserService
```go
type UserService interface {
    CreateUser(ctx context.Context, req CreateUserDTO) (*user.User, error)
    GetUserByID(ctx context.Context, id uuid.UUID) (*user.User, error)
    GetUsersByFamily(ctx context.Context, familyID uuid.UUID) ([]*user.User, error)
    UpdateUser(ctx context.Context, id uuid.UUID, req UpdateUserDTO) (*user.User, error)
    DeleteUser(ctx context.Context, id uuid.UUID) error
    ChangeUserRole(ctx context.Context, userID uuid.UUID, role user.Role) error
}
```

### ‚úÖ –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ Service (–ó–ê–í–ï–†–®–ï–ù)

#### ‚úÖ 2.1 –ú–∏–≥—Ä–∞—Ü–∏—è Create –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] **–í—ã–Ω–µ—Å—Ç–∏ –∏–∑ handlers** –æ–±—â—É—é –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  - –í–∞–ª–∏–¥–∞—Ü–∏—è email (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è email
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è (bcrypt)
  - –°–æ–∑–¥–∞–Ω–∏–µ user entity
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ repository

#### ‚úÖ 2.2 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] **GetUserByID** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- [x] **GetUsersByFamily** —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å–µ–º—å–µ
- [x] **UpdateUser** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [x] **DeleteUser** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [x] **ChangeUserRole** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ä–æ–ª–∏
- [x] **ValidateUserAccess** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ —Å–µ–º—å–µ
- [x] **GetUserByEmail** –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### ‚úÖ 2.3 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- [x] **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- [x] **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ —Å–µ–º—å–µ** –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- [x] **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ error types
- [x] **–ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏** Service Layer (100% –ø–æ–∫—Ä—ã—Ç–∏–µ –ª–æ–≥–∏–∫–∏)

### ‚úÖ –≠—Ç–∞–ø 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API Handler (–ó–ê–í–ï–†–®–ï–ù)

#### ‚úÖ 3.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API Handler
- [x] **–ò–Ω–∂–µ–∫—Ç–∏—Ç—å UserService** –≤ API Handler
- [x] **–£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É** –∏–∑ –º–µ—Ç–æ–¥–æ–≤
- [x] **–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞:
  ```go
  func (h *UserHandler) CreateUser(c echo.Context) error {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º API request –≤ DTO
      userDTO := dto.CreateUserDTO{...}

      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
      createdUser, err := h.userService.CreateUser(ctx, userDTO)
      if err != nil {
          return h.handleServiceError(c, err)
      }

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ API response
      return c.JSON(201, APIResponse[UserResponse]{...})
  }
  ```

#### ‚úÖ 3.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- [x] **–°–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–µ—Ä—ã** –º–µ–∂–¥—É API models –∏ DTOs
- [x] **–û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DTOs
- [x] **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API contracts** (–Ω–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints)
- [x] **–û–±–Ω–æ–≤–∏—Ç—å error handling** –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ service –æ—à–∏–±–æ–∫ –≤ HTTP –∫–æ–¥—ã

### –≠—Ç–∞–ø 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Web Handler (1 –¥–µ–Ω—å)

#### 4.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Web Handler
- [ ] **–ò–Ω–∂–µ–∫—Ç–∏—Ç—å UserService** –≤ Web Handler
- [ ] **–£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É** –∏–∑ –º–µ—Ç–æ–¥–æ–≤
- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞:
  ```go
  func (h *WebUserHandler) Create(c echo.Context) error {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º form –≤ DTO
      dto := convertFormToDTO(form)

      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
      user, err := h.userService.CreateUser(ctx, dto)
      if err != nil {
          return h.handleWebError(c, err) // Render HTML error
      }

      return c.Redirect(302, "/users")
  }
  ```

#### 4.2 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ–±-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∏
- [ ] **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å HTMX –ø–æ–¥–¥–µ—Ä–∂–∫—É** –≤ handlers
- [ ] **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å template rendering** –ª–æ–≥–∏–∫—É
- [ ] **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å CSRF –æ–±—Ä–∞–±–æ—Ç–∫—É**

### ‚úÖ –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è (–ó–ê–í–ï–†–®–ï–ù –¥–ª—è UserService)

#### ‚úÖ 5.1 Unit —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
- [x] **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã** –¥–ª—è `UserService` –º–µ—Ç–æ–¥–æ–≤ (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)
- [x] **Mock repositories** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] **–ü–æ–∫—Ä—ã—Ç—å edge cases** –∏ error scenarios
- [x] **–î–æ—Å—Ç–∏—á—å 100% coverage** –¥–ª—è UserService (–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Ü–µ–ª–∏)

#### ‚úÖ 5.2 Integration —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] **–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã** handlers –¥–ª—è UserHandler
- [x] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API endpoints** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Web endpoints** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (Web Handler –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç)
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HTMX —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** (Web Handler –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç)

#### ‚úÖ 5.3 –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤** `make test-fast` (916/916 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏)
- [x] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å linting** `make lint` (0 –æ—à–∏–±–æ–∫)
- [x] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–±–æ—Ä–∫—É** `make build` (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
```
internal/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ interfaces.go           # Service –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ user_service.go        # UserService —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ user_service_test.go   # Unit —Ç–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îú‚îÄ‚îÄ user_dto.go        # DTO –º–æ–¥–µ–ª–∏
‚îÇ       ‚îî‚îÄ‚îÄ mappers.go         # –ú–∞–ø–ø–µ—Ä—ã –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
‚îú‚îÄ‚îÄ application/handlers/
‚îÇ   ‚îî‚îÄ‚îÄ users.go               # API Handler (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω)
‚îú‚îÄ‚îÄ web/handlers/
‚îÇ   ‚îî‚îÄ‚îÄ users.go               # Web Handler (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–µ–Ω)
‚îî‚îÄ‚îÄ domain/user/
    ‚îî‚îÄ‚îÄ user.go                # Domain entities (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
```

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ DTOs

#### UserService Interface
```go
type UserService interface {
    // CRUD Operations
    CreateUser(ctx context.Context, req CreateUserDTO) (*user.User, error)
    GetUserByID(ctx context.Context, id uuid.UUID) (*user.User, error)
    GetUsersByFamily(ctx context.Context, familyID uuid.UUID) ([]*user.User, error)
    UpdateUser(ctx context.Context, id uuid.UUID, req UpdateUserDTO) (*user.User, error)
    DeleteUser(ctx context.Context, id uuid.UUID) error

    // Business Operations
    ChangeUserRole(ctx context.Context, userID uuid.UUID, role user.Role) error
    ValidateUserAccess(ctx context.Context, userID, resourceOwnerID uuid.UUID) error
}
```

#### DTO Models
```go
type CreateUserDTO struct {
    Email     string    `validate:"required,email"`
    FirstName string    `validate:"required,min=2,max=50"`
    LastName  string    `validate:"required,min=2,max=50"`
    Password  string    `validate:"required,min=6"`
    Role      user.Role `validate:"required"`
    FamilyID  uuid.UUID `validate:"required"`
}

type UpdateUserDTO struct {
    FirstName *string `validate:"omitempty,min=2,max=50"`
    LastName  *string `validate:"omitempty,min=2,max=50"`
    Email     *string `validate:"omitempty,email"`
}
```

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| –ü–æ–ª–æ–º–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö API | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | Thorough testing, –ø–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è |
| –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –ß–µ—Ç–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, code review |
| Performance –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –ë–µ–Ω—á–º–∞—Ä–∫–∏, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ |

### –ü—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ —Ä–∏—Å–∫–∏
| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è |
| Merge conflicts | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | –ß–∞—Å—Ç—ã–µ –∫–æ–º–º–∏—Ç—ã, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã |

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### Definition of Done (–¥–ª—è UserService)
- [x] **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** (unit, integration, e2e) - 916/916 ‚úÖ
- [x] **Linting —á–∏—Å—Ç—ã–π** (0 issues) - 0/0 ‚úÖ
- [x] **Code coverage ‚â• 85%** –¥–ª—è Service Layer - 100% ‚úÖ
- [x] **API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ ‚úÖ
- [ ] **Web interface —Ä–∞–±–æ—Ç–∞–µ—Ç** –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (–Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç)
- [ ] **HTMX —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞** (–Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç)
- [x] **Performance –Ω–µ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–ª–∞** - –±–µ–∑ –∑–∞–º–µ—Ç–Ω–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ ‚úÖ

### –ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (–¥–ª—è UserService)
- [x] **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ** - –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –≤ UserService ‚úÖ
- [x] **Handlers —É–ø—Ä–æ—â–µ–Ω—ã** - —Ç–æ–ª—å–∫–æ transport layer –ª–æ–≥–∏–∫–∞ –≤ UserHandler ‚úÖ
- [x] **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞** - UserService –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ ‚úÖ
- [x] **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞** –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö transport layers ‚úÖ

## üìÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏

### –û–±—â–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã: 6-9 –¥–Ω–µ–π
- **–≠—Ç–∞–ø 1**: 1-2 –¥–Ω—è (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- **–≠—Ç–∞–ø 2**: 2-3 –¥–Ω—è (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
- **–≠—Ç–∞–ø 3**: 1 –¥–µ–Ω—å (API —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)
- **–≠—Ç–∞–ø 4**: 1 –¥–µ–Ω—å (Web —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)
- **–≠—Ç–∞–ø 5**: 1-2 –¥–Ω—è (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å
1. Service interfaces ‚Üí Service implementation
2. API Handler refactoring ‚Üí Web Handler refactoring
3. Unit tests ‚Üí Integration tests ‚Üí Regression tests

## üîÑ –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞

### Rollback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
1. **Git branches**: –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ
2. **Feature flags**: –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ Service Layer
3. **A/B testing**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ handlers
4. **Backup**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö handlers –¥–æ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Rollback triggers
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏** –≤ production
- **Performance –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è** > 20%
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è** –≤ API/Web

---

**–í–ª–∞–¥–µ–ª–µ—Ü**: Backend Team
**Reviewer**: Tech Lead
**–°–ª–µ–¥—É—é—â–∏–π checkpoint**: –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≠—Ç–∞–ø–∞ 1
