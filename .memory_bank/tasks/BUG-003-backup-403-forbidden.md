# BUG-003: 403 Forbidden при создании резервной копии

## Статус: ✅ РЕШЕНО

## Приоритет: ВЫСОКИЙ

## Описание проблемы

При попытке создать резервную копию базы данных через админ-панель возвращается ошибка 403 Forbidden.

## Воспроизведение

1. Войти в систему как администратор
2. Перейти на страницу бэкапов (`/admin/backup`)
3. Нажать кнопку "Создать резервную копию"
4. Получить ошибку 403

## Лог сервера

```json
{
  "method": "POST",
  "path": "/admin/backup/create",
  "status": 403,
  "duration": 100343
}
```

## Анализ

Возможные причины 403 ошибки:

1. **CSRF токен** - не передаётся или невалидный
2. **Проблема с сессией** - на странице backup пропадает меню авторизованного пользователя (видно "Вход" и "Регистрация"
   вместо имени)
3. **Проверка роли** - middleware RequireAdmin() не распознаёт пользователя как админа
4. **Cookie** - сессионная кука не передаётся на POST запрос

## Локация бага

- **Endpoint**: `POST /admin/backup/create`
- **Handler**: `internal/web/handlers/backup.go` -> `CreateBackup`
- **Middleware**: `internal/web/middleware/auth.go` -> `RequireAdmin`
- **Routes**: `internal/web/web.go` строки 146-150

## Задачи по исправлению

1. [x] Проверить, что CSRF токен передаётся в форме бэкапа
2. [x] Проверить шаблон `internal/web/templates/admin/backup.html` на наличие CSRF
3. [x] Проверить middleware `RequireAdmin()` - корректно ли проверяется роль
4. [x] Проверить, что сессия корректно читается на странице backup
5. [x] Добавить логирование в middleware для диагностики
6. [x] Написать интеграционный тест на создание бэкапа
7. [x] Запустить `make lint` и `make test`

## Проверка CSRF в шаблоне

Убедиться, что в форме есть:

```html

<form hx-post="/admin/backup/create" ...>
    <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
    <!-- или -->
    {{ .CSRFField }}
</form>
```

Или HTMX заголовок:

```html

<button hx-post="/admin/backup/create"
        hx-headers='{"X-CSRF-Token": "{{ .CSRFToken }}"}'>
```

## Связанные файлы

- `internal/web/handlers/backup.go`
- `internal/web/templates/admin/backup.html`
- `internal/web/middleware/auth.go`
- `internal/web/middleware/csrf.go`
- `internal/web/web.go`

## Дополнительная проблема

На странице `/admin/backup` пропадает навигация авторизованного пользователя - показывается "Вход" и "Регистрация"
вместо имени пользователя. Это может быть связано с той же проблемой сессии.

## Критерии приёмки

- [x] Резервные копии создаются успешно
- [x] Навигация отображается корректно на странице backup
- [x] CSRF защита работает
- [x] Добавлен интеграционный тест
- [x] Все тесты проходят
- [x] Линтер не выдаёт ошибок

## Решение

**Найдена и исправлена основная проблема**

### Диагностика:
Проблема заключалась в том, что шаблон `admin/backup.html` **не включал необходимые компоненты** для корректной работы HTMX с CSRF защитой:

1. **Отсутствовал CSRF meta-тег** `<meta name="csrf-token" content="{{.CSRFToken}}" />`
2. **Не подключался `app.js`**, который содержит глобальный обработчик `htmx:configRequest` для автоматического добавления CSRF токена ко всем HTMX запросам

### Исправления:
**Файл**: `internal/web/templates/admin/backup.html`

1. Добавлен CSRF meta-тег в `<head>`:
```html
<!-- CSRF Token -->
{{if .CSRFToken}}
<meta name="csrf-token" content="{{.CSRFToken}}" />
{{end}}
```

2. Добавлен скрипт `app.js` перед закрывающим тегом `</body>`:
```html
<!-- Custom JavaScript -->
<script src="/static/js/app.js"></script>
```

### Как это работает:
1. CSRF токен генерируется в handler и передаётся в шаблон через `.CSRFToken`
2. Токен помещается в meta-тег `<meta name="csrf-token">`
3. Глобальный обработчик в `app.js` (строки 185-191) автоматически добавляет токен из meta-тега **ко всем HTMX запросам** через заголовок `X-Csrf-Token`
4. CSRF middleware проверяет токен в заголовке и пропускает запрос

### Результат:
- ✅ Все тесты проходят (5 тест-кейсов для backup handler)
- ✅ Линтер не выдаёт ошибок (0 issues)
- ✅ CSRF защита работает автоматически для всех HTMX запросов
- ✅ Навигация отображается корректно (получает сессию через `nav` template)
- ✅ Резервные копии создаются, восстанавливаются и удаляются успешно
