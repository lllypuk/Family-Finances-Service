version: "3.8"

services:
  # Family Budget Service - единый контейнер с SQLite
  family-budget:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: family-budget-service
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Server Configuration
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}

      # Database Configuration (SQLite)
      DATABASE_PATH: ${DATABASE_PATH:-/data/budget.db}

      # Application Configuration
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}

    volumes:
      # Persistent volume for SQLite database
      - budget_data:/data
    networks:
      - family-budget-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  budget_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_DIR:-.}/data

networks:
  family-budget-network:
    driver: bridge
