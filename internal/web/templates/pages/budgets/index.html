{{define "pages/budgets/index"}}
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.PageData.Title}} - –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</title>

    <!-- PicoCSS -->
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">

    <!-- HTMX -->
    <script src="/static/js/htmx.min.js"></script>

    <!-- CSRF Token for HTMX -->
    {{if .CSRFToken}}<meta name="csrf-token" content="{{.CSRFToken}}">{{end}}

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
</head>
<body>
    <!-- Navigation -->
    <nav class="container-fluid">
        <ul>
            <li>
                <a href="/" class="brand">
                    <strong>üí∞ –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</strong>
                </a>
            </li>
        </ul>
        <ul>
            {{if .CurrentUser}}
            <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/transactions">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a></li>
            <li><a href="/categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
            <li><a href="/budgets" class="current">–ë—é–¥–∂–µ—Ç—ã</a></li>
            <li><a href="/reports">–û—Ç—á–µ—Ç—ã</a></li>
            <li>
                <details class="dropdown">
                    <summary role="button" class="secondary">
                        {{.CurrentUser.FirstName}} {{.CurrentUser.LastName}}
                    </summary>
                    <ul>
                        <li><a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                        {{if eq .CurrentUser.Role "admin"}}
                        <li><a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
                        <li><a href="/family/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–º—å–∏</a></li>
                        {{end}}
                        <li>
                            <form method="POST" action="/logout" style="margin: 0;">
                                <input type="hidden" name="_token" value="{{.CSRFToken}}">
                                <button type="submit" class="outline">–í—ã—Ö–æ–¥</button>
                            </form>
                        </li>
                    </ul>
                </details>
            </li>
            {{end}}
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="grid">
                <div>
                    <h1>üí∞ {{.PageData.Title}}</h1>
                    <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                </div>
                <div>
                    <a href="/budgets/new" role="button" class="primary">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å –±—é–¥–∂–µ—Ç
                    </a>
                </div>
            </div>
        </div>

        <!-- Budget Filters -->
        <section>
            <details>
                <summary>üîç –§–∏–ª—å—Ç—Ä—ã –±—é–¥–∂–µ—Ç–æ–≤</summary>
            <form hx-get="/budgets"
                  hx-target="#budgets-list"
                  hx-trigger="change"
                  hx-include="this">

                <div class="grid">
                    <div>
                        <label for="period">–ü–µ—Ä–∏–æ–¥</label>
                        <select id="period" name="period">
                            <option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>
                            <option value="weekly" {{if eq .Filter.Period "weekly"}}selected{{end}}>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                            <option value="monthly" {{if eq .Filter.Period "monthly"}}selected{{end}}>–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                            <option value="yearly" {{if eq .Filter.Period "yearly"}}selected{{end}}>–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                            <option value="custom" {{if eq .Filter.Period "custom"}}selected{{end}}>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ</option>
                        </select>
                    </div>

                    <div>
                        <label for="is_active">–°—Ç–∞—Ç—É—Å</label>
                        <select id="is_active" name="is_active">
                            <option value="">–í—Å–µ –±—é–¥–∂–µ—Ç—ã</option>
                            <option value="true" {{if eq .Form.IsActive "true"}}selected{{end}}>–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="false" {{if eq .Form.IsActive "false"}}selected{{end}}>–¢–æ–ª—å–∫–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                        </select>
                    </div>
                </div>
            </form>
            </details>
        </section>

        <!-- Budget Summary Cards -->
        {{if .Budgets}}
        <section>
            <h2>–û–±–∑–æ—Ä –±—é–¥–∂–µ—Ç–æ–≤</h2>
        <div class="budget-summary">
            <!-- Statistics should be calculated in backend -->

            <div class="grid">
                <article class="summary-card">
                    <header>–ê–∫—Ç–∏–≤–Ω—ã—Ö –±—é–¥–∂–µ—Ç–æ–≤</header>
                    <h3>{{len .Budgets}}</h3>
                </article>

                <article class="summary-card">
                    <header>–û–±—â–∏–π –±—é–¥–∂–µ—Ç</header>
                    <h3>0.00 ‚ÇΩ</h3>
                </article>

                <article class="summary-card">
                    <header>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ</header>
                    <h3>0.00 ‚ÇΩ</h3>
                </article>

                <article class="summary-card">
                    <header>–ü—Ä–µ–≤—ã—à–µ–Ω–∏–π</header>
                    <h3>0</h3>
                </article>
            </div>
            </div>
        </section>
        {{end}}

        <!-- Budget List -->
        <section id="budgets-list">
        {{if .Budgets}}
        <div class="budget-grid">
            {{range .Budgets}}
            <article class="budget-card {{if not .IsActive}}inactive{{end}}">
                <header>
                    <div class="budget-header">
                        <h4>{{.Name}}</h4>
                        {{if not .IsActive}}
                            <span class="badge secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {{else if .IsOverBudget}}
                            <span class="badge danger">–ü—Ä–µ–≤—ã—à–µ–Ω</span>
                        {{else if eq .AlertLevel "warning"}}
                            <span class="badge warning">{{printf "%.0f" .Percentage}}%</span>
                        {{else}}
                            <span class="badge success">{{printf "%.0f" .Percentage}}%</span>
                        {{end}}
                    </div>

                    {{if .CategoryName}}
                    <small class="category-info">
                        <span class="category-color" style="background-color: {{.CategoryColor}}"></span>
                        {{.CategoryName}}
                    </small>
                    {{else}}
                    <small>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</small>
                    {{end}}
                </header>

                <!-- Progress Bar -->
                <div class="progress-section">
                    <div class="progress {{.ProgressBarClass}}"
                         hx-get="/budgets/{{.ID}}/progress"
                         hx-trigger="load, every 30s"
                         hx-swap="outerHTML">
                        <div class="progress-bar" style="width: {{if gt .Percentage 100.0}}100{{else}}{{printf "%.1f" .Percentage}}{{end}}%">
                            <span class="progress-text">{{printf "%.1f" .Percentage}}%</span>
                        </div>
                    </div>

                    <div class="progress-details">
                        <div class="amount-info">
                            <span class="spent">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {{.FormattedSpent}}</span>
                            <span class="total">–∏–∑ {{.FormattedAmount}}</span>
                        </div>
                        <div class="remaining {{if .IsOverBudget}}text-danger{{else}}text-success{{end}}">
                            –û—Å—Ç–∞–ª–æ—Å—å: {{.FormattedRemaining}}
                        </div>
                    </div>
                </div>

                <!-- Period and Time Info -->
                <div class="period-info">
                    <div class="grid">
                        <div>
                            <small>–ü–µ—Ä–∏–æ–¥: {{.Period}}</small>
                            <br><small>{{.StartDate.Format "02.01.2006"}} - {{.EndDate.Format "02.01.2006"}}</small>
                        </div>
                        <div style="text-align: right;">
                            {{if .IsActive}}
                                {{if gt .DaysLeft 0}}
                                    <small>–û—Å—Ç–∞–ª–æ—Å—å {{.DaysLeft}} –¥–Ω–µ–π</small>
                                {{else}}
                                    <small class="text-warning">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</small>
                                {{end}}
                            {{else}}
                                <small class="text-muted">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</small>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <footer>
                    <div class="button-group">
                        <a href="/budgets/{{.ID}}" role="button" class="secondary outline">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                        <a href="/budgets/{{.ID}}/edit" role="button" class="secondary outline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <button hx-delete="/budgets/{{.ID}}"
                                hx-confirm="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±—é–¥–∂–µ—Ç?"
                                hx-target="closest article"
                                hx-swap="outerHTML"
                                class="secondary outline">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </footer>
            </article>
            {{end}}
        </div>
        {{else}}
        <article>
            <div class="empty-state">
                <h3>–ë—é–¥–∂–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –±—é–¥–∂–µ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤.</p>
                <a href="/budgets/new" role="button" class="primary">–°–æ–∑–¥–∞—Ç—å –±—é–¥–∂–µ—Ç</a>
            </div>
        </article>
        {{end}}
        </section>
    </main>

    <!-- Footer -->
    <footer class="container">
        <hr>
        <div class="grid">
            <div>
                <small>¬© 2025 –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç</small>
            </div>
        </div>
    </footer>

    <!-- Custom JavaScript -->
    <script src="/static/js/app.js"></script>
</body>
</html>

<style>
    .button-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .button-group > * {
        margin: 0;
    }

    .budget-summary {
        margin: 1.5rem 0;
    }

    .summary-card {
        text-align: center;
        padding: 1rem;
    }

    .summary-card header {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--pico-muted-color);
    }

    .summary-card h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .budget-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin: 1.5rem 0;
    }

    .budget-card {
        border: 1px solid var(--pico-muted-border-color);
        border-radius: var(--pico-border-radius);
        padding: 1.5rem;
        background: var(--pico-card-background-color);
    }

    .budget-card.inactive {
        opacity: 0.6;
        border-style: dashed;
    }

    .budget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .budget-header h4 {
        margin: 0;
    }

    .category-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .category-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .progress-section {
        margin: 1rem 0;
    }

    .progress {
        width: 100%;
        height: 20px;
        background-color: var(--pico-muted-border-color);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--pico-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        transition: width 0.3s ease;
        position: relative;
    }

    .progress-text {
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        text-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .progress.progress-success .progress-bar { background-color: #28a745; }
    .progress.progress-info .progress-bar { background-color: #17a2b8; }
    .progress.progress-warning .progress-bar { background-color: #ffc107; }
    .progress.progress-danger .progress-bar { background-color: #dc3545; }

    .progress-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
    }

    .amount-info {
        display: flex;
        gap: 0.5rem;
    }

    .spent {
        font-weight: 600;
    }

    .period-info {
        margin: 1rem 0;
        padding: 0.75rem;
        background: var(--pico-background-color);
        border-radius: var(--pico-border-radius);
        font-size: 0.875rem;
    }

    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .badge.success { background-color: #d4edda; color: #155724; }
    .badge.warning { background-color: #fff3cd; color: #856404; }
    .badge.danger { background-color: #f8d7da; color: #721c24; }
    .badge.secondary { background-color: #e2e3e5; color: #383d41; }

    .text-success { color: #28a745; }
    .text-warning { color: #ffc107; }
    .text-danger { color: #dc3545; }
    .text-muted { color: var(--pico-muted-color); }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-state h3 {
        color: var(--pico-muted-color);
    }

    @media (max-width: 768px) {
        .budget-grid {
            grid-template-columns: 1fr;
        }

        .button-group {
            justify-content: stretch;
        }

        .button-group > * {
            flex: 1;
        }

        .progress-details {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
    }
</style>
{{end}}
